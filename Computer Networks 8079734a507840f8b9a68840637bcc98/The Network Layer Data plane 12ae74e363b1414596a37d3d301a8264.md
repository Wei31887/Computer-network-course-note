# The Network Layer: Data plane

# Overview of Network Layer

---

### Two key network-layer functions

---

1. **Forwarding**
    - move packets from a router‚Äôs input link to appropriate router output link
    **(inside the router)**
2. **Routing**
    - Determine routing path of packets from source to destination
    - routing algorithms

### Data plane & Control plane

---

- **Data** **plane**
    - Determine how datagram arrived at **input port is forwarded to router output port**
    - **local**, per-router function
- **Control** **plane**
    - Determine how datagram is routed among routers path from source host to destination host
    - network-wide logic
    
    **Two control-plane approaches:** 
    
    1. **traditional routing algorithms**: implemented in **routers**
    2. **software-defined networking (SDN)**: implemented in (remote) **servers**

## Forwarding and Routing: The Data and Control Planes

---

### Control Plane: The Traditional Approach

---

- **Individual** routing algorithm components **in each and every router** interact in the control plane.
- Each router has its routing algorithm and establish the forwarding table by its own.

![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled.png)

### Control Plane: Software-Defined Networking (SDN) Approach

---

- Remote controller computes and distributes the forwarding tables to be used by each and every router.
- **Software-defined networking (SDN)**, where the network is ‚Äúsoftware-defined‚Äù because the controller that computes forwarding tables and interacts with routers is implemented in software.

![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%201.png)

## Network Service Model

---

> The **network service model** defines the characteristics of end-to-end delivery of packets between sending and receiving hosts.
> 
- The Internet‚Äôs network layer provides a single service, known as **best-effort** service.
- No guarantees on:
    - Successful datagram delivery to destination.
    - timing or order of delivery
    - bandwidth available to end-to-end flow

# What‚Äôs Inside a Router?

---

> **Entity**
> 
> 1. Input ports
> 2. Switching 
> 3. Output ports

> **Function**
> 
> 1. Buffer management
> 2. Scheduling
> 

### Router architecture overview

---

![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%202.png)

1. **Input ports**
2. **Switching fabric**
3. **Output ports**
4. **Routing processor**
    - The routing processor performs control-plane functions

## Input Port Processing

---

![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%203.png)

According to the figure above, the processing from left to right is as follows,

1. Line termination: 
    - physical layer: bit-level reception
2. Data link processing:
    - link-layer processing
3. **Lookup, forwarding, queuing:**
    - **Router uses the forwarding table to look up the output port** to which an arriving packet will be forwarded via the switching fabric.

---

- The **forwarding table** is generated by two ways:
    1. (Traditional) Computed and updated by the routing processor 
        - using routing protocol to interact with the routing processors in other network routers
    2. Received from a remote **SDN** controller.
    
    ### **Decentralized switching**
    
    ---
    
    - **Match plus action**
        - Using header field values, lookup output port using forwarding table in input port memory
    - **Goal:** complete input port processing at ‚Äòline speed‚Äô
    - Input port queuing
        - if datagrams arrive faster than forwarding rate into switch fabric
    
    ---
    
    1. **Destination-based forwarding**
        - forward **based only on destination IP address (traditional)**
    2. **Generalized forwarding**
        - forward **based on any set of header field values**
    
    ### Destination-based forwarding (traditional)
    
    ---
    
    ![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%204.png)
    
    <aside>
    üí° **Longest Prefix Match**
    When looking for forwarding table entry for given destination address, **use longest address prefix** that matches destination address.
    
    </aside>
    

## Switching

---

> Through the switching fabric that the packets are actually switched (that is, forwarded) from an input port to an output port
> 
- **Transfer packet from input link to appropriate output link**
- **Switching rate**: rate at which packets can be transfer from inputs to outputs
    - Measured as multiple of input/output line rate
    - N inputs: switching rate N times line rate desirable
    
    ### Three major types of switching fabrics
    
    ---
    
    ![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%205.png)
    
    ### Switching via memory
    
    ---
    
    - **Characteristics**
        1. Switching based on direct control of CPU.
        2. Packet copied to system‚Äôs memory
        3. Speed limited by memory bandwidth (2 bus crossings per datagram)
    - **Scenario**
        
        The packet was copied from the input port into processor memory, and copied the packet to the output port‚Äôs buffers after finding the appropriate output port.
        
        If the memory bandwidth is such that a maximum of *B* packets per second, then the overall forwarding throughput must be less than *B/2*.
        
    
    ### Switching via a bus
    
    ---
    
    - **Characteristics**
        1. Datagram from input port memory to output port memory via a shared bus
        2. **Bus contention**: switching speed limited by bus bandwidth
    
    ### Switching via interconnection network
    
    ---
    

## Queuing (Input & output port)

---

![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%206.png)

### Input port queuing

---

1. Switch fabric slower than input ports 
    
    ‚Üí packets placed in the buffer 
    
    ‚Üí queueing occur
    
2. **Head-of-the-Line (HOL) blocking**
    - queued datagram at front of queue prevents others in queue from moving forward
    - for example, the green packet on the right hand figure experience HOL
    
    ![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%207.png)
    

### Output port queuing

---

- **Buffering** required when datagrams arrive from fabric faster than link transmission rate.
    - Which datagrams to drop if no free buffers? ‚Üí **Drop policy**
        
        ‚Üí Lack of buffers
        
        ‚Üí Datagrams can be lost due to congestion
        
- **Scheduling discipline** chooses among queued datagrams for transmission
    
    ‚Üí Priority scheduling ‚Äì who gets best performance, network neutrality
    

## Buffer Management

---

### buffer management

---

- **Drop**: which packet to add, drop when buffers are full
    - tail drop: drop arriving packet
    - priority: drop/remove on priority basis
- **Marking**: which packets to mark to signal congestion (ECN, RED)

### Packet scheduling

---

- Deciding which packet to send next on link
- **FCFS** (First Come, First Served)
    - packets transmitted in order of arrival to output port

### Scheduling policies: Priority

---

![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%208.png)

![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%209.png)

### Scheduling policies: Round Robin & weighted fair queueing

---

![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%2010.png)

# The Internet Protocol (IP)

---

### Overview of Network Layer

---

![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%2011.png)

## IPv4 Datagram Format

---

![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%2012.png)

- **Version number**.
 These 4 bits specify the IP protocol version of the datagram. By looking at the version number, the router can determine how to interpret the remainder of the IP datagram.
- **Time-to-live**
The **time-to-live (TTL)** field is included to ensure that datagrams do not circulate forever
    - This field is decremented by one each time the datagram is processed by a router. **If the TTL field reaches 0, a router must drop that datagram.**
- **Header checksum**
Note that the checksum must be recomputed and stored again at each router, since the TTL field, and possibly the options field as well, will change.

## IPv4 Addressing

---

### Introduction

---

- **IP address**:
    - **32-bit** identifier associated with **each host or router interface**

![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%2013.png)

### Subnets

---

<aside>
üí° **What‚Äôs a subnet ?**

- device interfaces that can physically reach each other **without passing through an intervening router**
</aside>

### IP addressing: CIDR

---

> **CIDR**: Classless InterDomain Routing (pronounced ‚Äúcider‚Äù)
> 
- subnet portion of address of arbitrary length
- address format: `a.b.c.d/x`,
    - where `x` indicates the **number of bits in the first part of the address.**

### How to get IP addresses?

---

- How does host get IP address?
    1.  hard-coded by sysadmin in config file (e.g.,/etc/rc.config in UNIX)
    2. **DHCP: Dynamic Host Configuration Protocol**
        - dynamically get address from as server

## DHCP

---

> **Host dynamically obtains IP address from network server when it ‚Äújoins‚Äù network**
> 
> - Can renew its lease on address in use
> - Allows reuse of addresses (only hold address while connected/on) ÔÇß
> - Support for **mobile** users who join/leave network (Ethernet host is available also).

- **Overview**
    1. **Host** **broadcasts** DHCP discover msg [optional]
    2. **DHCP server** responds (**broadcasts**) with DHCP offer msg [optional] ÔÇß 
    3. **Host** requests IP address: DHCP request msg
    4. **DHCP server** sends address: DHCP ack msg

![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%2014.png)

- **Other functions of DHCP**
    1. Give address of first-hop router for client
    2. Give name and IP address of DNS sever
    3. network mask (indicating network versus host portion of address)

![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%2015.png)

## NAT: network address translation

---

> All devices in local network share just **one IPv4 address** as far as outside world is concerned
> 

![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%2016.png)

- All devices in local network have 32-bit addresses in a ‚Äúprivate‚Äù IP address space 
(`**10/8`, `172.16/12`, `192.168/16`** prefixes) that can only be used in local network
- Advantages:
    - just one IP address needed from provider ISP for all devices
    - can change addresses of host in local network without notifying outside world
    - can change ISP without changing addresses of devices in local network
    - **security**: devices inside local net not directly addressable, visible by outside world
    
    ### Example
    
    ---
    
    ![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%2017.png)
    
    1. Host `10.0.0.1, 3345` sends datagrams to destination: `128.119.40.186, 80`
    2. NAT router changes source address from `10.0.0.1, 3345` to `138.76.29.7, 5001`, and updates table
    3. Reply arrives, destination address: `138.76.29.7, 5001`

## IPv6

---

### IPv6 datagram format

---

![IPv6](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%2018.png)

IPv6

- **128-bit IPv6 addresses**
    - 128 bits IP address ‚Üí 16bytes

- **Compared with IPv4**
    - **no checksum** (to speed processing at routers)
        - no fragmentation/reassembly
        - no options (available as upper-layer, next-header protocol at routerIPv4

![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%2019.png)

### Transition from IPv4 to IPv6

---

- **Tunneling**: IPv6 datagram carried as payload in IPv4 datagram among IPv4 routers (‚Äúpacket within a packet‚Äù)

![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%2020.png)

![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%2021.png)

# Generalized Forwarding and SDN

---

### **Review**

---

- each router contains a **forwarding table** (aka: flow table)
- **Match plus action**
    - match bits in arriving packet, then take action
- **Destination-based forwarding:** forward only based on **destination IP address**
- **Generalized forwarding:**
    - many header fields can determine action
    - many action possible:
        1. drop
        2. copy
        3. modify 
        4. log packet
    
    ![Generalized forwarding: Each packet switch contains a match-plus-action table that is computed and distributed by a remote controller](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%2022.png)
    
    Generalized forwarding: Each packet switch contains a match-plus-action table that is computed and distributed by a remote controller
    

### Flow table abstraction

---

- **Flow**: defined by header field values (in link-, network-, transport-layer fields)
- **Generalized forwarding**: simple packet-handling rules
    - **match**: pattern values in packet header fields
    - **actions**: for matched packet: drop, forward, modify, matched packet or send matched packet to controller
    - **priority**: disambiguate overlapping patterns
    - **counters**: #bytes and #packets
    - ‚Üí match then action

![Êà™Âúñ 2022-12-03 15.24.32.png](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/%25E6%2588%25AA%25E5%259C%2596_2022-12-03_15.24.32.png)

### OpenFlow

---

- Our following discussion of generalized forwarding will be based on OpenFlow

![Untitled](The%20Network%20Layer%20Data%20plane%2012ae74e363b1414596a37d3d301a8264/Untitled%2023.png)